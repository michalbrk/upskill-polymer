<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html"/>
<link rel="import" href="../../bower_components/paper-button-group/paper-button-group.html"/>
<link rel="import" href="../../bower_components/paper-button/paper-button.html"/>

<dom-module id="poly-todo">
    <template>
        <style>
            :host {
                display: block;
                height: 100vh;

                --poly-color: red;

                --paper-button-ink-color: magenta;
                --paper-button: {
                    border: solid 1px black;
                };
            }
        </style>

        <poly-todo-storage id="store" todos="{{todos}}"></poly-todo-storage>
        <poly-todo-header filter="{{filter}}"></poly-todo-header>
        <poly-todo-list todos="[[filteredTodos]]" on-item-updated="updateStore"></poly-todo-list>
        <poly-new-todo on-new-todo="_addTodo"></poly-new-todo>
    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class PolyTodo extends Polymer.Element {
            static get is() {
                return 'poly-todo';
            }

            static get properties() {
                return {
                    filteredTodos: {
                        computed: '_getFilteredTodos(todos.*, filter)'
                    },
                    todos: {
                        type: Array
                    }
                };
            }

            updateStore() {
                this.$.store.save();
            }

            _getFilteredTodos(array, filter) {
                let todos = array.base;

                if (filter)
                    todos = todos.filter(filter);

                return todos;
            }

            _addTodo(e) {
                this.push('todos', {
                    complete: false,
                    label: e.detail.label
                })
            }
        }

        window.customElements.define(PolyTodo.is, PolyTodo);
    </script>
</dom-module>

<dom-module id="poly-todo-storage">
    <template>
        <app-localstorage-document id="localStorage" key="poly-todos" data="{{todos}}"></app-localstorage-document>
    </template>

    <script>
        class PolyTodoStorage extends Polymer.Element {
            static get is() {
                return 'poly-todo-storage';
            }

            static get properties() {
                return {
                    todos: {
                        notify: true,
                        value: () => [{
                            complete: true,
                            label: 'Attend workshop'
                        }, {
                            complete: false,
                            label: 'Start using Polymer'
                        }]
                    }
                }
            }

            save() {
                this.$.localStorage.saveValue('poly-todos');
                this.notifySplices('todos');
            }
        }

        window.customElements.define(PolyTodoStorage.is, PolyTodoStorage);
    </script>
</dom-module>

<dom-module id="poly-todo-header">
    <template>
        <style>

            paper-button[active] {
                font-weight: bold;
                background-color: var(--poly-color);
                border: none;
                color: white;
            }

        </style>

        <paper-button-group selected="incomplete" selected-item="{{selectedButton}}" attr-for-selected="data-filter">
            <paper-button data-filter="all">All</paper-button>
            <paper-button data-filter="incomplete">Incomplete</paper-button>
            <paper-button data-filter="complete">Complete</paper-button>
        </paper-button-group>
    </template>

    <script>
        const filters = {
            all: () => true,
            incomplete: todo => todo.complete === false,
            complete: todo => todo.complete === true
        };

        class PolyTodoHeader extends Polymer.Element {
            static get is() {
                return 'poly-todo-header';
            }

            static get properties() {
                return {
                    filter: {
                        notify: true,
                        computed: '_getFilter(selectedButton)'
                    }
                }
            }

            _getFilter(selectedButton) {
                let selectedOption = 'all';
                if(selectedButton)
                    selectedOption = selectedButton.getAttribute('data-filter');

                return filters[selectedOption];
            }
        }

        window.customElements.define(PolyTodoHeader.is, PolyTodoHeader);
    </script>
</dom-module>

<dom-module id="poly-todo-list">
    <template>
        <style>
            div {
                display: flex;
                align-items: flex-end;
            }
        </style>

        <vaadin-grid items="[[todos]]">
            <vaadin-grid-column>
                <template class="header">
                    Do zrobienia
                </template>
                <template>
                    <paper-input value="{{item.label}}" disabled$="[[item.complete]]" on-blur="_notify"></paper-input>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column>
                <template>
                    <paper-icon-button icon="check" hidden$="[[item.complete]]" on-tap="_complete"></paper-icon-button>
                </template>
            </vaadin-grid-column>
        </vaadin-grid>
    </template>

    <script>
        class PolyTodoList extends Polymer.Element {
            static get is() {
                return 'poly-todo-list';
            }

            _complete(e) {
                this.set([ 'todos', e.model.index, 'complete' ], true);
                this._notify(e);
            }

            _notify(e) {
                this.dispatchEvent(new CustomEvent('item-updated'));
            }
        }

        window.customElements.define(PolyTodoList.is, PolyTodoList);
    </script>
</dom-module>

<dom-module id="poly-new-todo">
    <template>
        <paper-input label="Co muszę zrobić?" value="{{newTodo}}"></paper-input>
        <paper-button on-tap="_submitTodo">Add</paper-button>
    </template>

    <script>
        class PolyNewTodo extends Polymer.Element {
            static get is() {
                return 'poly-new-todo';
            }

            _submitTodo() {
                if(this.newTodo) {
                    this.dispatchEvent(new CustomEvent('new-todo', {
                        detail: {
                            label: this.newTodo
                        }
                    }));
                }

                this.newTodo = '';
            }
        }

        window.customElements.define(PolyNewTodo.is, PolyNewTodo);
    </script>
</dom-module>
